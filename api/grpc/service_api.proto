syntax = "proto3";

package velez_api;

import "google/api/annotations.proto";

import "npm.proto";
import "velez_common.proto";
import "velez_api.proto";

option go_package = "go.vervstack.ru/velez/pkg/velez_api;velez_api";
option (npm_package) = "@vervstack/velez";

service ServiceApi {
  rpc CreateService(CreateService.Request) returns (CreateService.Response) {
    option (google.api.http) = {
      post: "/api/service/create"
      body: "*"
    };
  }

  rpc GetService(GetService.Request) returns (GetService.Response) {
    option (google.api.http) = {
      post: "/api/service/get"
      body: "*"
    };
  }

  // CreateDeploy - create new deployment specification
  // and prepares to deploy service
  // updating specification is prohibited by design.
  // New deployment - new specification
  // Instance update goes gradually.
  // When new instances are deployed,
  // the old one stops receive traffic and
  // become obsolete (schedules to be deleted)
  rpc CreateDeploy(CreateDeploy.Request) returns (CreateDeploy.Response) {
    option (google.api.http) = {
      post: "/api/service/deploy/create"
      body: "*"
    };
  }

  rpc ListDeployments(ListDeployments.Request) returns (ListDeployments.Response) {
    option (google.api.http) = {
      post: "/api/service/deploy/list"
      body: "*"
    };
  }
}

message CreateService {
  message Request {
    string name = 1;
  }

  message Response {}
}


message GetService {
  message Request {
    oneof payload {
      uint64 id = 1;
      string name = 2;
    }
  }

  message Response {
    oneof payload {
      VervAppService verv_service = 1;
      // in future there might be other service types that needs to be managed
    }
  }
}

message VervAppService {
  uint64 id = 1;
  string name = 2;
}

message CreateDeploy {
  message Request {
    oneof specification {
      // Creates new deployment specification
      CreateSmerd.Request new = 1;
      // Takes current version and upgrades
      // only certain part of it (image)
      Upgrade upgrade = 2;
    }

    uint64 service_id = 3;

    message Upgrade {
      // Id of deployment from which to perform upgrade from
      uint64 deployment_id = 1;

      // Options to upgrade from. All optional.
      // If none is passed - simply creates new deployment
      // and restarts smerds
      optional string image = 2;
    }
  }

  message Response {}
}

message ListDeployments {
  message Request {
    Paging paging = 1;

    optional uint64 service_id = 2;
  }
  message Response {

  }
}