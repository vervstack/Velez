-- +goose Up
-- +goose StatementBegin

-- TODO удалить и заменить на скан вьюхи session.
--  При подключении к базе нужно указывать application_name=MyGoApp
CREATE TABLE IF NOT EXISTS velez.nodes
(
    id          INT4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        TEXT UNIQUE NOT NULL,
    last_online TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS velez.services
(
    id         INT8 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name       TEXT UNIQUE NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TYPE deployment_status AS ENUM (
    'SCHEDULED',
    'PREPARING',
    'CREATED',
    'RUNNING',
    'FAILED',
    'SCHEDULED_DELETION',
    'DELETED');

CREATE TABLE IF NOT EXISTS velez.deployments
(
    id                       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SERVICE_ID               INT8              NOT NULL REFERENCES velez.services (id),
    node_id                  INT4              NOT NULL REFERENCES velez.nodes (id),
    created_at               TIMESTAMPTZ       NOT NULL DEFAULT now(),
    updated_at               TIMESTAMPTZ       NOT NULL DEFAULT now(),
    status                   deployment_status NOT NULL,
    deployment_specification JSON              NOT NULL
);

-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin

DROP TABLE IF EXISTS velez.deployments;
DROP TYPE IF EXISTS deployment_status;
DROP TABLE IF EXISTS velez.services;
DROP TABLE IF EXISTS velez.nodes;
-- +goose StatementEnd
