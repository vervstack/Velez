-- +goose Up
-- +goose StatementBegin

CREATE TABLE IF NOT EXISTS velez.nodes
(
    id          INT4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        TEXT UNIQUE NOT NULL,
    last_online TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS velez.services
(
    id         INT8 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name       TEXT UNIQUE NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS velez.deployment_specifications
(
    id           INT8 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name         TEXT UNIQUE NOT NULL,
    created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
    verv_payload json
);

CREATE TYPE deployment_status AS ENUM (
    'SCHEDULED',
    'PREPARING',
    'CREATED',
    'RUNNING',
    'FAILED',
    'SCHEDULED_DELETION',
    'DELETED');

CREATE TABLE IF NOT EXISTS velez.deployments
(
    id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    service_id INT8              NOT NULL REFERENCES velez.services (id),
    node_id    INT4              NOT NULL REFERENCES velez.nodes (id),
    spec_id    INT8              NOT NULL REFERENCES velez.deployment_specifications,
    created_at TIMESTAMPTZ       NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ       NOT NULL DEFAULT now(),
    status     deployment_status NOT NULL
);

-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin

DROP TABLE IF EXISTS velez.deployments;
DROP TYPE IF EXISTS deployment_status;
DROP TABLE IF EXISTS velez.services;
DROP TABLE IF EXISTS velez.nodes;
-- +goose StatementEnd
