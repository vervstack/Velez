// Code generated by RedSock CLI. DO NOT EDIT.

package config

import (
	"flag"

	"go.redsock.ru/rerrors"
	"go.vervstack.ru/matreshka/pkg/matreshka"
)

var ErrAlreadyLoaded = rerrors.New("config already loaded")

type Config struct {
	AppInfo matreshka.AppInfo

	Servers     ServersConfig
	Environment EnvironmentConfig
	Overrides   matreshka.ServiceDiscovery

	MatreshkaConfig matreshka.AppConfig
}

var defaultConfig Config

const (
	devConfigPath  = "./config/dev.yaml"
	prodConfigPath = "./config/config.yaml"
)

func Load() (Config, error) {
	if defaultConfig.AppInfo.Name != "" {
		return defaultConfig, ErrAlreadyLoaded
	}

	var cfgPath string
	var isDevBuild bool

	flag.StringVar(&cfgPath, "config", "", "Path to configuration file")
	flag.BoolVar(&isDevBuild, "dev", false, "Flag turns on a dev config at ./config/dev.yaml")
	flag.Parse()

	configsPaths := []string{prodConfigPath}

	if cfgPath != "" {
		configsPaths = append(configsPaths, cfgPath)
	}

	if isDevBuild {
		configsPaths = append(configsPaths, devConfigPath)
	}

	var err error
	defaultConfig.MatreshkaConfig, err = matreshka.ReadConfigs(configsPaths...)
	if err != nil {
		return defaultConfig, rerrors.Wrap(err, "error reading matreshka config")
	}

	defaultConfig.AppInfo = defaultConfig.MatreshkaConfig.AppInfo
	defaultConfig.Overrides = defaultConfig.MatreshkaConfig.ServiceDiscovery

	err = defaultConfig.MatreshkaConfig.Servers.ParseToStruct(&defaultConfig.Servers)
	if err != nil {
		return defaultConfig, rerrors.Wrap(err, "Error parsing servers to config")
	}
	err = defaultConfig.MatreshkaConfig.Environment.ParseToStruct(&defaultConfig.Environment)
	if err != nil {
		return defaultConfig, rerrors.Wrap(err, "error parsing environment config")
	}

	return defaultConfig, nil
}
